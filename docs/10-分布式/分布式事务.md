## 分布式事务

### TCC

> Try-Confirm-Cancel

* Try
* Confirm
* Cancel

### 事务消息

> RocketMQ支持事务消息

***RocketMQ事务消息流程***

* 发送`prepared消息`到RocketMQ
* 执行本地事务
* 本地事务执行成功，更改RocketMQ中prepared消息状态为`COMMIT`
* 本地事务执行失败，更改RocketMQ中prepared消息状态为`ROLLBACK`
* 更改失败或超时，触发prepared消息`回查`

<p style="text-align: center;"><img src="_media/distribution/tx-message.jpg" alt="事务消息" style="width: 60%"></p>

```java
public void messageTransaction() {
    TransactionMQProducer producer = new TransactionMQProducer();
    // 注册prepared事务消息回查监听器
    producer.setTransactionCheckListener(new TransactionCheckListener() {

        @Override
        public LocalTransactionState checkLocalTransactionState(MessageExt msg) {
            // 检查本地事务
            if (checkLocalTransaction()) {
                return LocalTransactionState.COMMIT_MESSAGE;
            }
            return LocalTransactionState.ROLLBACK_MESSAGE;
        }

    });
    // 发送事务消息
    producer.sendMessageInTransaction(message, new LocalTransactionExecuter() {

        @Override
        public LocalTransactionState executeLocalTransactionBranch(Message msg, Object arg) {
            // 执行本地事务
            if (executeLocalTransaction()) {
                return LocalTransactionState.COMMIT_MESSAGE;
            }
            return LocalTransactionState.ROLLBACK_MESSAGE;
        }

    });
}
```
